!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).Recorderx={})}(this,function(e){"use strict";function i(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function d(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function c(e,t){for(var r=new Float32Array(t),i=0,a=0;i<e.length;a+=e[i].length,i+=1)r.set(e[i],a);return r}function u(e,t,r){if(t<r)throw new Error('Invalid parameter: "inputSampleRate" must be greater than "outputSampleRate"');for(var i=e.length,a=(t+=0)/(r+=0),n=Math.ceil(i*r/t),o=new Float32Array(n),s=0,c=0;c<n;c+=1)o[c]=e[Math.floor(s)],s+=a;return o}function l(e,t){if(-1===[8,16].indexOf(t))throw new Error('Invalid parameter: "sampleBits" must be 8 or 16');for(var r=e.length*(t/8),i=new ArrayBuffer(r),a=new DataView(i),n=0,o=0;n<e.length;n+=1,o+=t/8){var s=Math.max(-1,Math.min(1,e[n])),c=s<0?32768*s:32767*s;8===t?a.setInt8(o,parseInt(255/(65535/(32768+c)),10),!0):a.setInt16(o,c,!0)}return a.buffer}function h(e,t,r){if(-1===[8,16].indexOf(t))throw new Error('Invalid parameter: "sampleBits" must be 8 or 16');function i(e){for(var t=0;t<e.length;t+=1)o.setUint8(s+t,e.charCodeAt(t))}var a=e.length*(t/8),n=new ArrayBuffer(44+a),o=new DataView(n),s=0;i("RIFF"),s+=4,o.setUint32(s,36+a,!0),s+=4,i("WAVE"),s+=4,i("fmt "),s+=4,o.setUint32(s,16,!0),s+=4,o.setUint16(s,1,!0),s+=2,o.setUint16(s,1,!0),s+=2,o.setUint32(s,r,!0),s+=4,o.setUint32(s,1*r*(t/8),!0),s+=4,o.setUint16(s,t/8*1,!0),s+=2,o.setUint16(s,t,!0),s+=2,i("data"),s+=4,o.setUint32(s,a,!0),s+=4;for(var c=0;c<e.length;c+=1,s+=t/8){var u=Math.max(-1,Math.min(1,e[c])),l=u<0?32768*u:32767*u;8===t?o.setInt8(s,parseInt(255/(65535/(32768+l)),10),!0):o.setInt16(s,l,!0)}return new Blob([o],{type:"audio/wav"})}var m={recordable:!0,sampleRate:16e3,sampleBits:16,bufferSize:16384},v={READY:0,RECORDING:1},p={RAW:"raw",PCM:"pcm",WAV:"wav"},t=function(){function f(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:m,t=e.recordable,r=void 0===t?m.recordable:t,i=e.bufferSize,a=void 0===i?m.bufferSize:i,n=e.sampleRate,o=void 0===n?m.sampleRate:n,s=e.sampleBits,c=void 0===s?m.sampleBits:s;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,f),d(this,"state",v.READY),d(this,"ctx",new(window.AudioContext||window.webkitAudioContext)),d(this,"sampleRate",m.sampleRate),d(this,"sampleBits",m.sampleBits),d(this,"recordable",m.recordable),d(this,"recorder",null),d(this,"source",null),d(this,"stream",null),d(this,"buffer",[]),d(this,"bufferSize",0);var u=this.ctx,l=u.createScriptProcessor||u.createJavaScriptNode;this.recorder=l.call(u,a,1,1),this.recordable=r,this.sampleRate=o,this.sampleBits=c}return function(e,t,r){t&&i(e.prototype,t),r&&i(e,r)}(f,[{key:"start",value:function(a){var n=this;return this.ctx.resume(),new Promise(function(i,t){navigator.mediaDevices.getUserMedia({audio:!0}).then(function(e){var t=n.recorder,r=n.ctx.createMediaStreamSource(e);n.stream=e,n.source=r,t.onaudioprocess=function(e){var t=e.inputBuffer.getChannelData(0);n.recordable&&(n.buffer.push(t.slice(0)),n.bufferSize+=t.length),"function"==typeof a&&a(t)},r.connect(t),t.connect(n.ctx.destination),n.state=v.RECORDING,i(e)}).catch(function(e){t(e)})})}},{key:"pause",value:function(){this.stream.getAudioTracks()[0].stop(),this.recorder.disconnect(),this.source.disconnect(),this.ctx.suspend(),this.state=v.READY}},{key:"clear",value:function(){this.buffer=[],this.bufferSize=0}},{key:"getRecord",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{encodeTo:p.RAW,compressible:!1},t=e.encodeTo,r=void 0===t?p.RAW:t,i=e.compressible,a=void 0!==i&&i;if(this.recordable){var n=c(this.buffer,this.bufferSize),o=this.ctx.sampleRate,s=(a=a&&this.sampleRate<o)?this.sampleRate:o;switch(a&&(n=u(n,o,s)),r){case p.RAW:return n;case p.PCM:return l(n,this.sampleBits);case p.WAV:return h(n,this.sampleBits,s);default:throw new Error('Invalid parameter: "encodeTo" must be ENCODE_TYPE')}}throw new Error('Configuration error: "recordable" must be set to true')}}]),f}();void 0!==window&&void 0!==navigator&&(void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=function(r){var i=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return i?new Promise(function(e,t){i.call(navigator,r,e,t)}):Promise.reject(new Error("getUserMedia is not implemented in this environment"))}));var r={merge:c,compress:u,encodeToPCM:l,encodeToWAV:h};e.ENCODE_TYPE=p,e.RECORDER_STATE=v,e.audioTools=r,e.default=t,Object.defineProperty(e,"__esModule",{value:!0})});
